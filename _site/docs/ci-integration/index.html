<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Integrating with CI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="generator" content="ClusterRunner">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->
</head>


<body class="wrap">
  <header>
  <div class="os-banner hide-on-mobiles">
    <div class="grid one-third">
        <a href="http://opensource.box.com/"><img src="http://opensource.box.com/assets/images/logo.png"></a>
    </div>
  </div>

  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="current">
    <a href="/docs/home/">Doc<span class="show-on-mobiles">s</span><span class="hide-on-mobiles">umentation</span></a>
  </li>
  <li class="">
    <a href="/news/">Blog</a>
  </li>
  <li>
    <a href="https://github.com/box/ClusterRunner"><span class="hide-on-mobiles">View on </span>GitHub</a>
  </li>
</ul>

  </nav>
  <div class="grid">
    <div class="unit one-third center-on-mobiles" style="padding:25px 0 20px 0">
      <h1>
        <a href="/">
          <span>ClusterRunner</span>
          <img src="/img/box_clusterrunner_sml.png" height="80" alt="Logo">
        </a>
      </h1>
    </div>
    <nav class="main-nav unit two-thirds hide-on-mobiles">
      <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="current">
    <a href="/docs/home/">Doc<span class="show-on-mobiles">s</span><span class="hide-on-mobiles">umentation</span></a>
  </li>
  <li class="">
    <a href="/news/">Blog</a>
  </li>
  <li>
    <a href="https://github.com/box/ClusterRunner"><span class="hide-on-mobiles">View on </span>GitHub</a>
  </li>
</ul>

    </nav>
  </div>
</header>

    <section class="docs">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the docs…</option>
    
    <optgroup label="Getting Started">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/home/">Welcome</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/features/">Features</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/installation/">Installation</option>
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/quickstart/">Quick Start</option>
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="Tutorials">
      


  

  
    
  
    
  
    
  
    
  
    
      <option value="/docs/configuring-your-project/">Configuring Your Job</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
      <option value="/docs/ci-integration/">Integrating with CI</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="Reference">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/job-configuration/">Job Configuration</option>
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/service-configuration/">Service Configuration</option>
    
  
    
  
    
  

  

  
    
      <option value="/docs/api-docs/">API Docs</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
      <option value="/docs/build-result-format/">Build Result Format</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="Contribute">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/docs/development-guide/">Development Guide</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
  </select>
</div>


      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    
    <h4>Getting Started</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/home/">Welcome</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/features/">Features</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/installation/">Installation</a></li>
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/quickstart/">Quick Start</a></li>
    
  
    
  
    
  
    
  


</ul>

    
    <h4>Tutorials</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/configuring-your-project/">Configuring Your Job</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
      <li class="current"><a href="/docs/ci-integration/">Integrating with CI</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>Reference</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/job-configuration/">Job Configuration</a></li>
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/service-configuration/">Service Configuration</a></li>
    
  
    
  
    
  


  

  
    
  

  
    
      <li class=""><a href="/docs/api-docs/">API Docs</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
      <li class=""><a href="/docs/build-result-format/">Build Result Format</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>Contribute</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/development-guide/">Development Guide</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
  </aside>
</div>


      <div class="unit four-fifths">
        <article>
          <h1>Integrating with CI</h1>
          <p>Operating at scale is where ClusterRunner really shines, and with ClusterRunner in your testing pipeline you can start taking fast feedback for granted.</p>

<p>Follow the steps below and you’ll have a lovely Cluster of your own.</p>

<h2 id="overview">Overview</h2>

<p>Simply put, ClusterRunner integrates with your existing infrastructure by transforming CI slaves into ClusterSlaves,
and using the ClusterMaster as the entry-point for executing jobs.</p>

<p>From the users point of view, the CI systems behave exactly in the same way – just faster.</p>

<p>The change can be visualized in the following way:</p>

<p><img src="/img/cr-arch-high-level2.png" width="100%" /></p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Before you can set up a distributed cluster, there are a few things you need to take care of first:</p>

<ol>
  <li>Choose the hosts you’ll use as a ClusterMaster and ClusterSlaves</li>
  <li>Confirm SSH daemon running on all hosts in cluster</li>
  <li>Exchange SSH keys between master/slaves</li>
  <li>Exchange SSH keys with Git server</li>
</ol>

<h3 id="take-inventory-of-your-ci-executors">1. Take inventory of your CI executors</h3>

<p>The first step when building out a Cluster is to know what machines you have available.</p>

<p>Take a bit of time to review your hosts, catalog their Operating Systems, and choose which one will be a 
ClusterMaster and which will be ClusterSlaves.</p>

<div class="note unreleased">
  <h5>Master &amp; Slave Operating Systems</h5>
  <p>At this time the master and slaves must all use the same type of operating system. We plan to add support 
  for heterogeneous environments in the future.</p>
</div>

<h3 id="enable-ssh-access-on-hosts">2. Enable SSH access on hosts</h3>

<h4 id="os-x-setup">OS X setup</h4>

<p>To enable SSH on OS X, use these <a href="http://support.apple.com/kb/PH13759">instructions</a>.</p>

<h4 id="linux-setup">Linux Setup</h4>

<p>SSH access is enabled out-of-the-box for most Linux installs. If you find that it is not, please check the manual for your distro.</p>

<h3 id="exchange-masterslave-ssh-keys">3. Exchange master/slave SSH keys</h3>

<p>ClusterRunner relies on SSH to dynamically deploy and configure slaves. Password prompts will halt the 
process.</p>

<h4 id="os-x-and-linux">OS X and Linux</h4>

<p>Set up <a target="_blank" href="http://www.linuxproblem.org/art_9.html">passwordless SSH</a> between your 
master and slaves.</p>

<div class="note info">
    <p>It should take about a minute to manually exchange keys between the ClusterMaster and the first ClusterSlave (and faster for each subsequent slave). This is a one-time setup.</p>
</div>

<h3 id="exchange-ssh-keys-with-git">4. Exchange SSH keys with Git</h3>

<p>ClusterSlaves fetch code from your repository – and ClusterRunner uses SSH as the primary Git communication protocol.</p>

<p>In order for ClusterRunner to operate smoothly, we strongly recommend you exchange SSH keys between your slaves and your Git server.</p>

<div class="note info">
    <p>For any Git infrastructure, we recommend you generate a single private key (~/.ssh/id_rsa) on your master, and then push that file to all of your slaves.</p>
</div>

<h4 id="github">GitHub</h4>

<p>GitHub provides a comprehensive <a href="https://help.github.com/articles/generating-ssh-keys/">set of instructions</a> for key exchange.</p>

<h4 id="self-hosted-git">Self-hosted Git</h4>

<p>Please refer to someone knowledgeable in the configuration of your Git service. Different Git services (git, gitolite, gitlab, etc.) handle user-key management in different ways, so we’re unable to provide guidance for this step.</p>

<h2 id="steps-to-integrate-clusterrunner">Steps to Integrate ClusterRunner</h2>

<h3 id="deploy-and-test-the-clusterrunner-service">1. Deploy and test the ClusterRunner service</h3>

<p>To start your first distributed cluster, SSH to your ClusterMaster and run the commands below:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Make sure you've done the "installation instructions" above</span>
	
<span class="c"># Start the ClusterMaster process and specify the hostnames of your ClusterSlaves</span>
~ <span class="nv">$ </span>clusterrunner deploy --slaves hostname1 hostname2 hostname3
	
<span class="c"># Run the tests for our "Simple job"</span>
~ <span class="nv">$ </span>clusterrunner build git --url git@github.com:boxengservices/ClusterRunnerDemo.git --branch master --job-name Simple 

<span class="c"># The exit code indicates success/failure!</span></code></pre></div>

<!--
<div class="note">
  <h5>Using CI to start up ClusterRunner</h5>
  <p>We recommend that you eventually have an automated process setup to start/keep-running your Cluster. This can 
  be as easy as a CI job that executes the commands on your CR Master, or as thorough as a config rule (such as in 
  Chef/Puppet) to keep the service alive.
  </p>
</div>
-->

<p>Validate that the above “build” command was successful by checking the console output.</p>

<p><em>Now take a moment to celebrate that you have an fully-functioning distributed test cluster. Hooray.</em></p>

<h3 id="label-your-clustermaster">3. Label your ClusterMaster</h3>

<p>Triggering ClusterRunner jobs is done via executing CLI commands on the ClusterMaster. In order to do that, you must
identify the ClusterMaster in some way.</p>

<p>In Jenkins, this is done by editing the Node configuration as follows:</p>

<center><img src="/img/ci-jenkins-label.png" height="150" /></center>

<h3 id="modify-your-jobs-to-use-clusterrunner">4. Modify your jobs to use ClusterRunner</h3>

<p>Now that you have an operating Cluster in place, it’s time to reconfigure a CI job to leverage the resource.</p>

<h4 id="invoke-clusterrunner">4.1 Invoke ClusterRunner</h4>

<p>Transitioning a CI job to use ClusterRunner is incredibly simple – and often only a single line of code in your CI job:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>clusterunner build git --url &lt;url to git repo&gt; --branch &lt;branch&gt; --hash &lt;<span class="nb">hash</span>&gt; --job-name &lt;job name&gt;</code></pre></div>

<p>The “job name” represents any job you’ve defined in your project’s <a href="/docs/job-configuration/">job configuration</a>.</p>

<p>The “hash” is optional.</p>

<div class="note">
  <h5>Performance Hint</h5>
  <p>If you use the "--url" argument, your CI system does not need to check out your repo's code into the build workspace. (The ClusterMaster will do this automatically.) 
  This can save you seconds of execution time!</p>
</div>

<div class="note info">
    <p>Don't forget to restrict this job to run only on CI nodes with the "cluster-master" label!</p>
</div>

<h4 id="publish-build-results-in-ci">4.2 Publish build results in CI</h4>

<p>Build results for any invocation of <code>clusterrunner build</code> are aggregated into the 
<code>./build_results/</code> directory.</p>

<p>To consume these results, simply configure your CI system to publish the appropriate pattern of results in that 
directory. In Jenkins, this looks like:</p>

<center><img src="/img/ci-build-results.png" height="150" /></center>

<h3 id="optional-unmount-clusterslaves-from-your-ci-system">5. [optional] Unmount ClusterSlaves from your CI system</h3>

<p>We recommend that you disconnect ClusterSlaves from your CI Master.</p>

<p>Since ClusterRunner wil be using these hosts to their full capacity, we recommend that you try to avoid running Jenkins 
jobs on them directly while they are operating as ClusterSlaves.</p>

<p><i>How we do it at Box: If you do choose to keep these mounted, we recommend adding a special label to them (such as 
“clusterslave”) so you can exclude them from other job definitions.</i></p>

<h3 id="profit">6. Profit!</h3>

<p>Sit back and enjoy the effects of ClusterRunners’ capabilities.</p>

<p>As you increase your Cluster size and add more work to the system, you’ll be amazed at how efficiently ClusterRunner 
utilizes the resources you have available and provides faster test feedback.</p>

          <div class="section-nav">
  <div class="left align-right">
    
      
      
      
        

          
          

        
        
      
        

          
          

        

          
          

        

          
          

        

          
          

        
        
      
        

          
          
            
          

        

          
          
            <a href="/docs/configuring-your-project/" class="prev">Back</a>
            
            
        

      
    
  </div>

  <div class="right align-left">
    
      
      
      
        

          
          

        

          
          

        

          
          

        

          
          

        
        
      
        

          
          

        

          
          
            
          

        
        
      
        

          
          
            <a href="/docs/job-configuration/" class="next">Next</a>
            
            
        

      
    
  </div>
  <div class="clear"></div>
</div>


        </article>
      </div>


      <div class="clear"></div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>Box Open Source</p>
    </div>
    <div class="unit two-thirds align-right center-on-mobiles">
      <p>
        Proudly hosted by
        <a href="https://github.com">
          <img src="/img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
        </a>
      </p>
    </div>
  </div>
</footer>

  <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<i class=\"fa fa-link\"></i>";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("news")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>

  
  <!-- Gauges (http://gaug.es/) -->
  <script>
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', 'ZZZ');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>



  <!-- Google Analytics (http://google.com/analytics) -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'ZZZ', 'clusterrunner.com');
    ga('send', 'pageview');

  </script>



</body>
</html>
